(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{314:function(s,a,t){"use strict";t.r(a);var e=t(12),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql备份策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql备份策略"}},[s._v("#")]),s._v(" MySQL备份策略")]),s._v(" "),a("h2",{attrs:{id:"_1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-概述"}},[s._v("#")]),s._v(" 1. 概述")]),s._v(" "),a("p",[s._v("根据墨菲定律，数据库在运行过程中，终会遇到各种各样的问题: 硬件故障、Bug 导致数据损坏、由于服务器宕机或者其他原因造成的数据库不可用。\n如果有 DBA 告诉你，这个数据库能够恢复到两个个月内任何状态，这说明了，这个数据库的 binlog 日志至少保留了两个月。备份 binlog 的好处:")]),s._v(" "),a("ul",[a("li",[s._v("可以实现基于任意时间点的恢复")]),s._v(" "),a("li",[s._v("可以用于误操作数据闪回")]),s._v(" "),a("li",[s._v("可以用于审计\n当你要进行数据恢复的时候，就会非常庆幸有做 "),a("code",[s._v("binlog")]),s._v(" 备份。当然，使用 "),a("code",[s._v("binlog")]),s._v(" 恢复数据的前提是 "),a("code",[s._v("binlog")]),s._v(" 格式要设为 "),a("code",[s._v("row")]),s._v("，不要担心空间问题，当前最不缺的资源就是硬盘空间。对于 "),a("code",[s._v("binlog")]),s._v("，推荐的配置是")])]),s._v(" "),a("div",{staticClass:"language-ini line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录每一行数据的变化")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_format")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("row")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备库在重做数据的时候，记录一条 binlog")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_slave_updates")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"有哪些备份方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有哪些备份方式"}},[s._v("#")]),s._v(" 有哪些备份方式")]),s._v(" "),a("blockquote",[a("p",[a("strong",[a("code",[s._v("逻辑备份")])]),s._v(" : 逻辑备份是最常见的方式，在数据量比较少的时候很常用。")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("优点")]),s._v("：\n"),a("ol",[a("li",[s._v("备份恢复比较简单，例如 "),a("code",[s._v("mysqldump")]),s._v(" 就是 MySQL 自带的备份工作，无需额外安装。恢复的时候可以直接使用 "),a("code",[s._v("mysql")]),s._v(" 命令进行恢复。")]),s._v(" "),a("li",[s._v("可以远程备份和恢复，也就是说，可以在其他机器执行备份命令。")]),s._v(" "),a("li",[s._v("备份出来的数据非常直观，备份出来后，可以使用 "),a("code",[s._v("sed")]),s._v(" "),a("code",[s._v("grep")]),s._v(" 等工具进行数据提取或者修改。")]),s._v(" "),a("li",[s._v("与存储引擎无关，因为备份文件是直接从 MySQL 里面提取出来的数据，所以在直观上，备份数据数据不对引擎做区分，可以很方便地从 "),a("code",[s._v("MyISAM")]),s._v(" 引擎改到 "),a("code",[s._v("InnoDB")]),s._v(" 引擎。")]),s._v(" "),a("li",[s._v("避免受到文件损坏的影响，如果直接复制原始文件，可能会受到某个文件损坏的影响而得到一个损坏的备份。使用逻辑备份，只要 MySQL 还能执行 SELECT 语句，就可以得到一份可以信赖的逻辑备份，在文件损坏的时候很有用。")])])]),s._v(" "),a("li",[a("code",[s._v("缺点")]),s._v("：\n"),a("ol",[a("li",[s._v("因为必须使用 MySQL 服务进行数据操作，所以备份的时候会占用更多 CPU，且备份时间可能会更长。")]),s._v(" "),a("li",[s._v("逻辑备份在某些场景下比数据库文件更大，文本存储的数据不总是比存储引擎更高效。当然，使用压缩的话会得到一个更小的备份，但是要占用 CPU 资源。（如果索引较多，逻辑备份会比物理备份小。）")]),s._v(" "),a("li",[s._v("恢复时间更长，使用逻辑备份的数据恢复，需要占用更多资源去进行锁分配、索引构建、冲突检查、日志刷新。")])])]),s._v(" "),a("li",[a("code",[s._v("常用方法")]),s._v("：\n"),a("ol",[a("li",[a("code",[s._v("mysqldump")]),s._v(" 是 "),a("code",[s._v("MySQL")]),s._v("自带的备份工具，通用性强，非常常见。使用的使用通常要加上一些参数，后面继续介绍。")]),s._v(" "),a("li",[a("code",[s._v("select into outfile")]),s._v("，以符号分割数据创建逻辑备份，对于要导入到 "),a("code",[s._v("CSV")]),s._v(" 等表格会比较实用。")]),s._v(" "),a("li",[a("code",[s._v("mydumper")]),s._v("，允许使用多线程进行备份，备份文件会进行表结构和数据分离，在恢复某些表或数据的时候会非常有效。")])])])])]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[a("strong",[a("code",[s._v("物理备份")])]),s._v(": 物理备份在数据量较大的时候非常常见。")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("优点")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("备份速度快，因为物理备份是基于复制进行备份，意味者复制有多快，备份就能有多快。")]),s._v(" "),a("li",[s._v("恢复速度快，只需要把文件复制到数据库目录就可以完成恢复，不需要检查锁、构建索引。")]),s._v(" "),a("li",[s._v("恢复简单，对于 MySIAM 引擎的表，不需要停库，只需要简单地复制进数据目录就可以。对于 InnoDB，如果是每个表一个表空间，也可以不停库操作，使用卸载加载表空间的方式便可导入（不太安全）。")])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("缺点")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("没有官方物理热备份工具的支持。没有官方工具的支持，意味着出问题的概率较大，使用的时候就要谨慎了")]),s._v(" "),a("li",[s._v("InnoDB 的原始文件通常比逻辑备份要大。InnoDB 表空间往往包含很多未被使用的空间，InnoDB 表在删除数据后不会释放空间，所以即使数据量不大，文件有可能很大。除此以外，文件中除了数据还包含了索引、日志等信息。")]),s._v(" "),a("li",[s._v("物理备份不总可以跨平台跨版本。MySQL 文件和操作系统、MySQL 版本息息相关，如果环境与原来不一致，很有可能会出现问题。")])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("常用方法")]),s._v("：")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("xtrabackup")]),s._v(" 是最常用的物理备份工具，由 "),a("code",[s._v("percona")]),s._v(" 开源，能够实现对 InnoDB 存储引擎和 XtraDB 存储引擎非阻塞地备份（对于 MyISAM 还是要加锁），得到一份一致性备份。")]),s._v(" "),a("li",[a("code",[s._v("直接复制文件/文件系统快照")]),s._v("，这种方式对于 "),a("code",[s._v("MySIAM")]),s._v(" 引擎是非常高效的，只需要执行 "),a("code",[s._v("FLUSH TABLE WITH READ LOCK")]),s._v(" 就可以复制得到一份备份文件。但是对于 "),a("code",[s._v("InnoDB")]),s._v(" 引擎就比较困难，因为 "),a("code",[s._v("InnoDB")]),s._v(" 引擎使用了大量的异步技术，即使执行了 "),a("code",[s._v("FLUSH TABLE WITH READ LOCK")]),s._v("，它还是会继续合并日志、缓存数据。所以要用这种方法备份 "),a("code",[s._v("InnoDB")]),s._v("，需要确保 "),a("code",[s._v("checkpoint")]),s._v(" 已经最新。")])])])])]),s._v(" "),a("h2",{attrs:{id:"_2-全量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-全量备份"}},[s._v("#")]),s._v(" 2. 全量备份")]),s._v(" "),a("p",[s._v("全量备份介绍最常用的逻辑备份工具 "),a("code",[s._v("mysqldump")]),s._v(" 和物理备份工具 "),a("code",[s._v("xtrabackup")]),s._v("。如果对 "),a("code",[s._v("mysqldump")]),s._v(" 不太满意 可以使用 "),a("code",[s._v("mydumper")]),s._v(" 来替代 "),a("code",[s._v("mysqldump")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"_2-1-mysqldump"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-mysqldump"}},[s._v("#")]),s._v(" 2.1 mysqldump")]),s._v(" "),a("p",[a("code",[s._v("mysqldump")]),s._v(" 是用得最多的工具，需要增加一些额外的参数。"),a("code",[s._v("mysqldump")]),s._v(" 有很多可用参数，建议直接访问官网 "),a("a",{attrs:{href:"https://link.segmentfault.com/?enc=kDGBSqEshWDPuY4pUtZlVQ%3D%3D.G9G1LVS%2Fw0QMpAJAsjhGpAmDcStIkffhGiulkdIMNRcpenbrCy%2FF%2F3Vkma1G%2FlW2xs2CKAz4NPsjkpky0oUYfg%3D%3D",target:"_blank",rel:"noopener noreferrer"}},[s._v("mysqldump"),a("OutboundLink")],1),s._v("。使用 "),a("code",[s._v("mysqldump")]),s._v(" 某些参数需要 "),a("code",[s._v("select,reload,lock tables")]),s._v(" 权限。")]),s._v(" "),a("h4",{attrs:{id:"innodb-全库备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb-全库备份"}},[s._v("#")]),s._v(" InnoDB 全库备份")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysqldump "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--opt")]),s._v(" --single-transaction --master-data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" --default-character-set"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8 -h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" backup.sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("--opt")]),s._v(" 如果有这个参数表示同时激活了mysqldump命令的quick，add-drop-table，add-locks，extended-insert，lock-tables参数，它可以给出很快的转储操作并产生一个可以很快装入MySQL服务器的转储文件。当备份大表时，这个参数可以防止占用过多内存")]),s._v(" "),a("li",[a("code",[s._v("--single-transaction")]),s._v(" 设置事务的隔离级别为可重复读，然后备份的时候开启事务，这样能保证在一个事务中所有相同的查询读取到同样的数据。注意，这个参数只对支持事务的引擎有效，如果有 "),a("code",[s._v("MyISAM")]),s._v(" 的数据表，并不能保证数据一致性")]),s._v(" "),a("li",[a("code",[s._v("-A")]),s._v(" 导出全部数据库")]),s._v(" "),a("li",[a("code",[s._v("–-default-character-set=charset")]),s._v(" 指定导出数据时采用何种字符集")]),s._v(" "),a("li",[a("code",[s._v("--master-data=2")]),s._v(" 表示在备份过程中记录主库的 "),a("code",[s._v("binlog")]),s._v(" 和 "),a("code",[s._v("pos")]),s._v(" 点，并在dump文件中注释掉这一行，在使用备份文件做新备库时会用到")])]),s._v(" "),a("h4",{attrs:{id:"myisam-全库备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#myisam-全库备份"}},[s._v("#")]),s._v(" MyISAM 全库备份")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysqldump "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--opt")]),s._v(" --lock-all-tables --master-data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" --default-character-set"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8 -h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" backup.sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("--lock-all-tables")]),s._v(" 锁表备份。由于 "),a("code",[s._v("MyISAM")]),s._v(" 不能提供一致性读，如果要得到一份一致性备份，只能进行全表锁定。")])]),s._v(" "),a("h4",{attrs:{id:"备份带上压缩"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份带上压缩"}},[s._v("#")]),s._v(" 备份带上压缩")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysqldump -h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" backup.sql.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"备份多个库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份多个库"}},[s._v("#")]),s._v(" 备份多个库")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysqldump -h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--databases")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("dbname"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("dbname"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" backup.sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[s._v("#")]),s._v(" 恢复")]),s._v(" "),a("p",[s._v("恢复方式比较简单，直接执行 sql 语句就可以了")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysql -h"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" backup.sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"mysqldump执行流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysqldump执行流程"}},[s._v("#")]),s._v(" mysqldump执行流程")]),s._v(" "),a("p",[s._v("打开 "),a("code",[s._v("general_log")]),s._v(" 可以查看 "),a("code",[s._v("mysqldump")]),s._v(" 的执行流程，这里以 "),a("code",[s._v("--single-transaction --opt -A")]),s._v(" 参数为例")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("FLUSH "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*!40101 LOCAL */")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v("\nFLUSH "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SESSION")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRANSACTION")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ISOLATION")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LEVEL")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPEATABLE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRANSACTION")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gtid\\_mode'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" MASTER "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNLOCK")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("IF")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXISTS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("employees"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SAVEPOINT")]),s._v(" sp\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*!40001 SQL_NO_CACHE */")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("departments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_2-2-xtrabackup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-xtrabackup"}},[s._v("#")]),s._v(" 2.2 xtrabackup")]),s._v(" "),a("h4",{attrs:{id:"安装方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装方式"}},[s._v("#")]),s._v(" 安装方式")]),s._v(" "),a("p",[s._v("更多安装方式参考官网 "),a("a",{attrs:{href:"https://www.percona.com/doc/percona-xtrabackup/8.0/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("xtrabackup"),a("OutboundLink")],1),s._v("\n这里我们使用 "),a("code",[s._v("rpm")]),s._v(" 安装的方式")]),s._v(" "),a("div",{staticClass:"language-apache line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum install http://www.percona.com/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm\nyum update percona-release\n# qpress 用作压缩解压\nyum install percona-xtrabackup-24 qpress\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"使用方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[s._v("#")]),s._v(" 使用方法")]),s._v(" "),a("h4",{attrs:{id:"增加备份账号并授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增加备份账号并授权"}},[s._v("#")]),s._v(" 增加备份账号并授权")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'localhost'")]),s._v(" IDENTIFIED "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" PROCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("RELOAD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" CLIENT "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'localhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nFLUSH "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"全备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全备"}},[s._v("#")]),s._v(" 全备")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("innobackupex --defaults-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/my.cnf "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--password")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pwd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("要备份到哪个目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --no-timestamp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--compress")]),s._v(" --compress-threads"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--parallel")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("--no-timestamp")]),s._v(" 不使用当前时间建立文件夹。默认情况下会在备份目录以当前时间创建文件夹")]),s._v(" "),a("li",[a("code",[s._v("--compress")]),s._v(" 压缩")]),s._v(" "),a("li",[a("code",[s._v("--compress-threads=N")]),s._v(" 压缩线程")]),s._v(" "),a("li",[a("code",[s._v("--parallel=N")]),s._v(" 备份线程")])]),s._v(" "),a("h4",{attrs:{id:"恢复-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复-2"}},[s._v("#")]),s._v(" 恢复")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤一：解压")]),s._v("\ninnobackupex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--decompress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--parallel")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤二：应用日志")]),s._v("\ninnobackupex --apply-log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--parallel")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤三：复制备份文件到数据目录")]),s._v("\ninnobackupex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--datadir")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("MySQL数据目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --copy-back "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--parallel")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"_3-增量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-增量备份"}},[s._v("#")]),s._v(" 3. 增量备份")]),s._v(" "),a("p",[s._v("当数据了变得庞大时，一个常见策略就是做定期的增量备份。例如：周一做了一次全量备份，然后周二到日做增量备份。\n增量备份只包含变化的数据集，一般情况不会比原始数据量大，所以可以减少服务器的开销、备份时间、备份空间。\n当然，使用增量备份也会有风险，增量备份每一次迭代都是基于上一次的备份实现，意味着只要其中一份备份出现问题，那么就有可能导致所有备份不可用。")]),s._v(" "),a("h3",{attrs:{id:"_3-1-使用-xtrabackup-做增量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-使用-xtrabackup-做增量备份"}},[s._v("#")]),s._v(" 3.1 使用 xtrabackup 做增量备份")]),s._v(" "),a("p",[s._v("xtrabackup 允许进行增量备份，命令如下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("innobackupex --defaults-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/my.cnf "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--password")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pwd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --no-timestamp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--compress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--incremental")]),s._v(" --incremental-basedir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份的目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("要增量备份到什么目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("恢复：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤一：对全备解压")]),s._v("\ninnobackupex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--decompress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤二：对全备应用日志")]),s._v("\ninnobackupex --apply-log --redo-only "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤三：对增量备份进行解压")]),s._v("\ninnobackupex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--decompress")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("增量文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤四：合并增量数据")]),s._v("\ninnobackupex --apply-log --redo-only "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--incremental")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --incremental-dir"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("增量文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤五：对合并后的数据应用日志")]),s._v("\ninnobackupex --apply-log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 步骤六：复制备份文件到数据目录")]),s._v("\ninnobackupex "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--datadir")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("MySQL数据目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --copy-back "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("全量备份文件所在目录"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h3",{attrs:{id:"_3-2-使用-binlog-做增量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-使用-binlog-做增量备份"}},[s._v("#")]),s._v(" 3.2 使用 binlog 做增量备份")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("binlog")]),s._v(" 做增量备份比较简单，备份的时候执行 "),a("code",[s._v("FLUSH LOGS")]),s._v(" 轮转日志，然后把旧的 "),a("code",[s._v("binlog")]),s._v(" 复制到备份目录就可以了。\n恢复的时候使用 "),a("code",[s._v("mysqlbinlog --start-position=<备份集的pos点> binlog日志 | mysql -u<user> -p")]),s._v(" 就可以了")]),s._v(" "),a("h2",{attrs:{id:"_4-延迟同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-延迟同步"}},[s._v("#")]),s._v(" 4. 延迟同步")]),s._v(" "),a("p",[s._v("延迟同步是常见的使用主从复制使用模式，在遇到误操作的时候，无论是用于恢复数据，还是使用跳过的方式跳过错误都是非常有用。\n例如在主库做了 "),a("code",[s._v("drop")]),s._v(" 的误操作，在主库找到命令所在 binlog 日志和 pos 位置，Delay库停止同步，\n然后使用 "),a("code",[s._v("start slave until master_log_file='<对应file>',master_log_pos=<误操作命令前一个SQL的pos>;")]),s._v(" 等待同步到这个位置，执行跳过一条 SQL 的命令再开启同步。\n常见的延迟同步复制模式有:\n一主带三从")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://segmentfault.com/img/bVbvTuo?w=333&h=318",alt:"图片描述"}})]),s._v(" "),a("p",[s._v("有时候为了减少主库压力，会把延迟库放在备节点之后")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://segmentfault.com/img/bVbvTun?w=333&h=321",alt:"图片描述"}})]),s._v(" "),a("p",[s._v("延迟同步开启方式如下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("stop slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nCHANGE MASTER TO MASTER_DELAY "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" N秒"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nstart slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"_5-数据校验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-数据校验"}},[s._v("#")]),s._v(" 5. 数据校验")]),s._v(" "),a("p",[s._v("除了备份，非常重要的一件事情就是验证备份数据的可用性。想象一下，当你需要进行数据恢复的时候，忽然发现过去的备份数据都是无效的，那得有多难受。很多朋友在写好备份脚本加到定时任务后，只要检查到定时任务有执行，备份目录有文件就不再关注了，往往到了需要使用备份文件的时候才发现备份数据有问题。")]),s._v(" "),a("p",[s._v("目前对于备份文件的数据校验没有非常方便的办法，用的比较多的还是定时把备份文件拉出来做备份恢复演练，例如一个月做一次备份恢复演练就可以有效提高备份文件可用性，心里也踏实。")]),s._v(" "),a("p",[s._v("数据校验部分，如果是逻辑备份，往往会抽查某个表的数据，检查是否符合预期。如果是物理备份，首先要使用 "),a("code",[s._v("mysqlcheck")]),s._v(" 等命令检查是否有表损坏，没有损坏再抽查表数据。")]),s._v(" "),a("h2",{attrs:{id:"_6-总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-总结"}},[s._v("#")]),s._v(" 6. 总结")]),s._v(" "),a("ol",[a("li",[s._v("逻辑备份和物理备份可以一起使用，不同的备份周期使用不同的工具，全备周期不应该太长，至少一周一次全备")]),s._v(" "),a("li",[s._v("如果数据量较大，可以使用增量备份的方式减少数据量，要注意的是，增量备份风险更大")]),s._v(" "),a("li",[s._v("binlog功能要开启，设为 "),a("code",[s._v("row")]),s._v(" 模式，设置 "),a("code",[s._v("log_slave_updates = 1")]),s._v("，且最好定时备份 binlog")]),s._v(" "),a("li",[s._v("有条件的话可以增加一个 Delay 库，在做紧急恢复的时候有奇效")]),s._v(" "),a("li",[s._v("数据校验要定时去做，否则当需要备份恢复的时候而备份文件又失效，后悔都来不及")])]),s._v(" "),a("blockquote",[a("p",[s._v("参考资料: - 高性能MySQL（第3版）")])])])}),[],!1,null,null,null);a.default=r.exports}}]);