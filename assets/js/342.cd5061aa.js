(window.webpackJsonp=window.webpackJsonp||[]).push([[342],{616:function(e,a,t){"use strict";t.r(a);var s=t(12),r=Object(s.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"pagecloudplus-tidb-operator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pagecloudplus-tidb-operator"}},[e._v("#")]),e._v(" PageCloudPlus TiDB Operator")]),e._v(" "),a("h2",{attrs:{id:"什么是-tidb-operator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是-tidb-operator"}},[e._v("#")]),e._v(" 什么是 TiDB Operator")]),e._v(" "),a("p",[e._v("TiDB Operator 是 TiDB 在 Kubernetes 平台上的自动化部署运维工具。目前，TiDB Operator 已正式开源（"),a("a",{attrs:{href:"http://www.qfdmy.com/wp-content/themes/quanbaike/go.php?url=aHR0cHM6Ly9naXRodWIuY29tL3BpbmdjYXAvdGlkYi1vcGVyYXRvci8=",target:"_blank",rel:"noopener noreferrer"}},[e._v("pingcap/tidb-operator"),a("OutboundLink")],1),e._v("）。借助 TiDB Operator，TiDB 可以无缝运行在公有云厂商提供的 Kubernetes 平台上，让 TiDB 成为真正的 Cloud-Native 数据库")]),e._v(" "),a("h2",{attrs:{id:"为什么-tidb-operator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么-tidb-operator"}},[e._v("#")]),e._v(" 为什么 TiDB Operator")]),e._v(" "),a("h3",{attrs:{id:"运维成本高"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运维成本高"}},[e._v("#")]),e._v(" 运维成本高")]),e._v(" "),a("p",[e._v("使用传统的自动化工具带来了很高的部署和运维成本。TiDB 的分层架构对于分布式系统是比较常见的，各个组件都可以根据业务需求独立水平伸缩，并且 TiKV 和 TiDB 都可以独立使用。比如，在 TiKV 之上可以构建兼容 Redis 协议的 KV 数据库，而 TiDB 也可以对接 LevelDB 这样的 KV 存储引擎。")]),e._v(" "),a("p",[e._v("但是，这种多组件的分布式系统增加了手工部署和运维的成本。一些传统的自动化部署和运维工具如 Puppet/Chef/SaltStack/Ansible，由于缺乏全局状态管理，不能及时对各种异常情况做自动故障转移，并且很难发挥分布式系统的弹性伸缩能力。其中有些还需要写大量的 DSL 甚至与 Shell 脚本一起混合使用，可移植性较差，维护成本比较高。")]),e._v(" "),a("h3",{attrs:{id:"为云而生"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为云而生"}},[e._v("#")]),e._v(" 为云而生")]),e._v(" "),a("p",[e._v("在云时代，容器成为应用分发部署的基本单位，而谷歌基于内部使用数十年的容器编排系统 Borg 经验推出的开源容器编排系统 Kubernetes 成为当前容器编排技术事实上的标准。如今各大云厂商都开始提供托管的 Kubernetes 集群，部署在 Kubernetes 平台的应用可以不用绑定在特定云平台，轻松实现在各种云平台之间的迁移，其容器化打包和发布方式也解决了对操作系统环境的依赖。")]),e._v(" "),a("h3",{attrs:{id:"有状态的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有状态的"}},[e._v("#")]),e._v(" 有状态的")]),e._v(" "),a("p",[e._v("Kubernetes 项目最早期只支持无状态服务（Stateless Service）的管理。无状态服务通过 ReplicationController 定义多个副本，由 Kubernetes 调度器来决定在不同节点上启动多个 Pod，实现负载均衡和故障转移。对于无状态服务，多个副本对应的 Pod 是等价的，所以在节点出现故障时，在新节点上启动一个 Pod 与失效的 Pod 是等价的，不会涉及状态迁移问题，因而管理非常简单。")]),e._v(" "),a("p",[e._v("但是对于有状态服务（Stateful Service），由于需要将数据持久化到磁盘，使得不同 Pod 之间不能再认为成等价，也就不能再像无状态服务那样随意进行调度迁移。")]),e._v(" "),a("p",[e._v("Kubernetes v1.3 版本提出 PetSet 的概念，用来管理有状态服务并于 v1.5 将其更名为 StatefulSet。StatefulSet 明确定义一组 Pod 中每个的身份，启动和升级都按特定顺序来操作。另外使用持久化卷存储（PersistentVolume）来作为存储数据的载体，当节点失效 Pod 需要迁移时，对应的 PV 也会重新挂载，而 PV 的底层依托于分布式文件系统，所以 Pod 仍然能访问到之前的数据。同时 Pod 在发生迁移时，其网络身份例如 IP 地址是会发生变化的，很多分布式系统不能接受这种情况。所以 StatefulSet 在迁移 Pod 时可以通过绑定域名的方式来保证 Pod 在集群中网络身份不发生变化。")]),e._v(" "),a("p",[e._v("但是由于有状态服务的特殊性，当节点出现异常时，出于数据安全性考虑，Kubernetes 并不会像无状态服务那样自动做故障转移。尽管网络存储能挂载到不同的节点上供其上的 Pod 使用，但是如果出现节点故障时，简单粗暴地将网络 PV 挂载到其它节点上是比较危险的。")]),e._v(" "),a("p",[e._v("Kubernetes 判断节点故障是基于部署在每个节点上的 Kubelet 服务是否能正常上报节点状态，Kubelet 能否正常工作与用户应用并没有必然联系，在一些特殊情况下，Kubelet 服务进程可能无法正常启动，但是节点上的业务容器还在运行，将 PV 再挂载到其它节点可能会出现双写问题。")]),e._v(" "),a("p",[e._v("为了在 Kubernetes 上部署和管理 TiDB 这种有状态的服务，我们需要扩展 StatefulSet 的功能。TiDB Operator 正是基于 Kubernetes 内置的 StatefulSet 开发的 TiDB 集群管理和运维工具。")]),e._v(" "),a("p",[e._v("Kubernetes 直到 v1.7 才试验性引入本地 PV，在这之前只有网络 PV，TiKV 自身在存储数据时就是多副本的，网络 PV 的多副本会增加数据冗余，降低 TiDB 的性能。在这之前我们基于 Kubernetes 内置的 hostPath volume 实现了本地 PV 满足 TiKV 对磁盘 IO 的要求。官方本地 PV 方案直到最近的 Kubernetes v1.10 才相对稳定地支持调度功能，满足用户对本地 PV 的需求。为了降低用户的使用和管理成本并且拥抱 Kubernetes 开源社区，我们又重新基于官方的本地 PV 方案实现了对数据的管理。")]),e._v(" "),a("h2",{attrs:{id:"原理解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理解析"}},[e._v("#")]),e._v(" 原理解析")]),e._v(" "),a("p",[e._v("Operator 本质上是 Kubernetes 的控制器（Controller），其核心思想是用户给定一个 Spec 描述文件，Controller 根据 Spec 的变化，在 Kubernetes 集群中创建对应资源，并且不断调整资源使其状态满足用户预期的 Spec。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://pic.sansei.top/images/kubernetes/kube77125efaac33d11.png",alt:""}})]),e._v(" "),a("p",[e._v("上图是 TiDB Operator 工作流程原理图，其中 TidbCluster 是通过 CRD（Custom Resource Definition）扩展的内置资源类型：")]),e._v(" "),a("ul",[a("li",[e._v("用户通过 Helm 往 Kubernetes API Server 创建或更新 TidbCluster 对象")]),e._v(" "),a("li",[e._v("TiDB Operator 通过 watch API Server 中的 TidbCluster 对象创建更新或删除，维护 PD/TiKV/TiDB StatefulSet, Service 和 Deployment 对象更新")]),e._v(" "),a("li",[e._v("Kubernetes 根据 StatefulSet, Service 和 Deployment 对象创建更新或删除对应的容器和服务")])]),e._v(" "),a("p",[e._v("在第 2 步中，TiDB Operator 在更新 StatefulSet 等对象时会参考 PD API 给出的集群状态来做出 TiDB 集群的运维处理。通过 TiDB Operator 和 Kubernetes 的动态调度处理，创建出符合用户预期的 TiDB 集群")]),e._v(" "),a("h2",{attrs:{id:"安装-tidb-operator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-tidb-operator"}},[e._v("#")]),e._v(" 安装 TiDB Operator")]),e._v(" "),a("p",[e._v("TiDB Operator 需要运行在 Kubernetes v1.10 及以上版本。TiDB Operator 和 TiDB 集群的部署和管理是通过 Kubernetes 平台上的包管理工具 Helm 实现的。运行 TiDB Operator 前请确保 Helm 已经正确安装在 Kubernetes 集群里")]),e._v(" "),a("h3",{attrs:{id:"要求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#要求"}},[e._v("#")]),e._v(" 要求")]),e._v(" "),a("ul",[a("li",[e._v("Kubernetes v1.10 或更高版本")]),e._v(" "),a("li",[e._v("DNS 插件，如 Calico")]),e._v(" "),a("li",[e._v("PersistentVolume")]),e._v(" "),a("li",[e._v("开启 RBAC (可选)")]),e._v(" "),a("li",[e._v("Helm version >= v2.8.2 and < v3.0.0")])]),e._v(" "),a("blockquote",[a("p",[a("strong",[e._v("注意：")]),e._v(" TiDB 可以使用网络卷存储 TiDB 数据，但存在冗余复制操作，导致性能降低。强烈建议设置本地卷获得更好的性能。\n"),a("strong",[e._v("注意：")]),e._v(" 网络卷做备份设置需要 Kubernetes v1.12 或更高版本")])]),e._v(" "),a("h3",{attrs:{id:"克隆项目到本地"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#克隆项目到本地"}},[e._v("#")]),e._v(" 克隆项目到本地")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" clone https://github.com/pingcap/tidb-operator.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" tidb-operator\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"部署本地卷"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署本地卷"}},[e._v("#")]),e._v(" 部署本地卷")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" manifests/local-dind/local-volume-provisioner.yaml\nkubectl get po "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-l")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("local-volume-provisioner\nkubectl get "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("pv")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" local-storage\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[e._v("#")]),e._v(" 安装")]),e._v(" "),a("ul",[a("li",[e._v("安装 CRD")])]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" manifests/crd.yaml\nkubectl get crd tidbclusters.pingcap.com\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("ul",[a("li",[e._v("安装完 TidbCluster 后再在 Kubernetes 集群中安装 Operator，")])]),e._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 修改 tidb-operator/charts/tidb-operator/values.yaml 配置")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kubeSchedulerImageName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" registry.aliyuncs.com/google_containers/kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("scheduler\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("helm "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" charts/tidb-operator "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tidb-operator "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--namespace")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tidb-admin\nkubectl get po "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" tidb-admin "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-l")]),e._v(" app.kubernetes.io/name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tidb-operator\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"卸载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#卸载"}},[e._v("#")]),e._v(" 卸载")]),e._v(" "),a("ul",[a("li",[e._v("查看 Helm 资源")])]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("helm "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ls")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-a")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 输出如下")]),e._v("\nNAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE \ntidb-operator   "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("               Tue Jul "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("23")]),e._v(" 07:22:22 "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2019")]),e._v("        DEPLOYED        tidb-operator-dev                       tidb-admin\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("ul",[a("li",[e._v("卸载 Helm 资源")])]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("helm delete tidb-operator "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--purge")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 输出如下")]),e._v("\nrelease "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"tidb-operator"')]),e._v(" deleted\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);